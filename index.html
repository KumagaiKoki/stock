<script>
  const apiKey = '8b308e8a86084cf2b1a7f4f56069685c'; 
  let chart;

  async function loadData(period) {
    const intervalMap = {
      '1day': ['5min', 1],
      '1week': ['30min', 7],
      '1month': ['1day', 30],
      '3months': ['1day', 90],
      '6months': ['1day', 180],
      '1year': ['1day', 365],
      '2years': ['1week', 104],
      '5years': ['1month', 60],
      'max': ['1month', 120]
    };

    const [interval, points] = intervalMap[period];
    const url = `https://api.twelvedata.com/time_series?symbol=AAPL&interval=${interval}&outputsize=${points}&apikey=${apiKey}`;

    const res = await fetch(url);
    const data = await res.json();

    console.log('API response:', data);

    if (!data || !data.values) {
      alert('データ取得失敗: ' + (data.message || 'APIのレスポンスにvaluesがありません'));
      return;
    }

    const labels = data.values.map(entry => entry.datetime).reverse();
    const prices = data.values.map(entry => parseFloat(entry.close)).reverse();

    const average = prices.reduce((sum, val) => sum + val, 0) / prices.length;
    const avgLine = Array(prices.length).fill(average);

    renderChart(labels, prices, avgLine, average);
  }

  function renderChart(labels, prices, avgLine, average) {
    const ctx = document.getElementById('stockChart').getContext('2d');

    if (chart) chart.destroy();

    chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'AAPL 株価（終値）',
            data: prices,
            borderColor: 'rgba(75,192,192,1)',
            borderWidth: 2,
            pointRadius: 0,
            fill: false,
            tension: 0.2
          },
          {
            label: `平均株価: ${average.toFixed(2)} USD`,
            data: avgLine,
            borderColor: 'red',
            borderWidth: 1,
            borderDash: [5, 5],
            pointRadius: 0,
            fill: false
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            ticks: { maxTicksLimit: 10 }
          },
          y: {
            beginAtZero: false
          }
        },
        plugins: {
          legend: {
            labels: {
              boxWidth: 12
            }
          }
        }
      }
    });
  }

  loadData('1month');
</script>
